// Dashboard data with updated information from attached files
const dashboardDataExato = {
  "contratos": [
    {
      "nome": "Logum Logística S/A",
      "referencia": "B133825CBB0014",
      "ressegurado": "Chubb Seguros Brasil S/A",
      "linha_negocio": "Property and Construction",
      "executivo": "Victor Molinari",
      "divisao": "LLP 7 - Gallagher Re Brazil",
      "total_controles": 32,
      "conformes": 28,
      "nao_conformes": 3,
      "nao_aplicaveis": 1,
      "problemas_spoe": 0,
      "taxa_conformidade": 90.3,
      "itens_conformes": [
        "Instruções por escrito do cliente / prospect recebidas",
        "Resseguradores possuem licença local para operar",
        "Ressegurador satisfaz Política de Market Security",
        "Ressegurador pré-aprovado pelo Cliente",
        "Parceiros comerciais aprovados no Open Twins",
        "Evidência da cotação salva adequadamente",
        "Slip de cotação emitido",
        "TOBA enviado ao Cliente",
        "Confirmação do cliente (Ordem Firme) recebida",
        "Número de referência gerado no Open Twins",
        "Confirmação salva na rede",
        "100% da ordem colocada ou shortfall justificado",
        "Confirmação de participação dos resseguradores",
        "Negativa de resseguradores locais documentada",
        "Exclusões e condições expressas adequadamente",
        "E-mail template de confirmação enviado",
        "Cláusula de Intermediação incluída",
        "Cláusula de Insolvência incluída",
        "Cláusula de Cancelamento incluída",
        "Cláusula de submissão de disputas incluída",
        "Vigência da cobertura especificada",
        "Cláusula de sanções (LMA 3100) incluída",
        "Impostos aplicáveis especificados",
        "Brokerage e deduções especificadas",
        "Exclusões e condições devidamente descritas",
        "Acordo de divisão de comissão documentado",
        "Pro forma spreadsheet salvo na rede",
        "Slips cadastrados no controle de documentação"
      ],
      "itens_nao_conformes": [
        "Existe exposição a territórios sancionados sem documentação adequada",
        "Data da Proposta e Aceitação não especificada no documento",
        "Acordo adicional de fee não documentado formalmente"
      ],
      "itens_nao_aplicaveis": [
        "Aprovação do time de Financial Crime (não necessária para este caso)"
      ]
    },
    {
      "nome": "Nordeste Logística II S.A",
      "referencia": "B133824TOK0038",
      "ressegurado": "Tokio Marine Seguradora S.A.",
      "linha_negocio": "Marine & Energy",
      "executivo": "Moisés Oliveira",
      "divisao": "LLP 7 - Gallagher Re Brazil",
      "total_controles": 12,
      "conformes": 7,
      "nao_conformes": 4,
      "nao_aplicaveis": 1,
      "problemas_spoe": 2,
      "taxa_conformidade": 63.6,
      "itens_conformes": [
        "Instruções por escrito recebidas do cliente/ressegurador",
        "Endosso inserido no Open Twins",
        "Verificação SPOE para Endosso Final realizada",
        "Endosso assinado por todos os resseguradores",
        "Exclusões e condições expressas adequadamente",
        "Confirmação do endosso informada ao cliente",
        "Arquivos suporte devidamente salvos"
      ],
      "itens_nao_conformes": [
        "Exposição a territórios sancionados sem documentação adequada",
        "Falta evidência de SPOE para Mudmap Final",
        "Falta verificação SPOE antes do envio da Documentação Final",
        "Modelo de e-mail template não utilizado adequadamente"
      ],
      "itens_nao_aplicaveis": [
        "Aprovação do time de Financial Crime não necessária"
      ]
    },
    {
      "nome": "Braskem S.A.",
      "referencia": "B133826BRA0045",
      "ressegurado": "Liberty Seguros S.A.",
      "linha_negocio": "Property and Construction",
      "executivo": "Eduardo Silva",
      "divisao": "LLP 7 - Gallagher Re Brazil",
      "total_controles": 32,
      "conformes": 29,
      "nao_conformes": 2,
      "nao_aplicaveis": 1,
      "problemas_spoe": 0,
      "taxa_conformidade": 93.5,
      "itens_conformes": [
        "TOBA enviado ao Cliente",
        "Instruções por escrito recebidas",
        "Resseguradores com licença local",
        "Ressegurador satisfaz Market Security Policy",
        "Ressegurador pré-aprovado pelo Cliente",
        "Parceiros comerciais aprovados no Open Twins",
        "Evidência da cotação salva",
        "SPOE para Slip de Cotação realizado",
        "Slip de cotação emitido no template Gallagher Re",
        "Cotações recebidas e arquivadas",
        "Ordem Firme formalizada",
        "100% da ordem colocada ou shortfall justificado",
        "Confirmação de participação dos resseguradores",
        "Negativa de resseguradores locais documentada",
        "Exclusões e Subjetividades adequadas",
        "SPOE para Mudmap Final e email realizado",
        "SPOE para E-mail template realizado",
        "E-mail com Nota de Cobertura enviado",
        "Cláusulas obrigatórias incluídas",
        "Acordo de divisão de comissão documentado",
        "Pro forma spreadsheet salvo",
        "SPOE para Slip/Redação realizado",
        "Slips cadastrados adequadamente",
        "Cláusula de Intermediação incluída",
        "Cláusula de Insolvência incluída",
        "Cláusula de Cancelamento incluída",
        "Vigência da cobertura especificada",
        "Impostos aplicáveis especificados",
        "Brokerage e deduções especificadas"
      ],
      "itens_nao_conformes": [
        "Exposição a territórios sancionados sem documentação",
        "Acordo adicional de fee não documentado"
      ],
      "itens_nao_aplicaveis": [
        "Aprovação Financial Crime não necessária"
      ]
    },
    {
      "nome": "Martins Comércio e Serviços de Distribuição S/A",
      "referencia": "B133825MAP0003",
      "ressegurado": "Mapfre Seguros Gerais S.A.",
      "linha_negocio": "Property - Riscos Nomeados",
      "executivo": "Vitor Molinari",
      "divisao": "LLP 7 - Gallagher Re Brazil",
      "total_controles": 36,
      "conformes": 28,
      "nao_conformes": 6,
      "nao_aplicaveis": 2,
      "problemas_spoe": 1,
      "taxa_conformidade": 82.4,
      "itens_conformes": [
        "TOBA enviado ao Cliente",
        "Instruções por escrito recebidas",
        "Resseguradores com licença local",
        "Ressegurador satisfaz Market Security Policy",
        "Ressegurador pré-aprovado pelo Cliente",
        "Parceiros comerciais aprovados no Open Twins",
        "Evidência da cotação salva",
        "SPOE para Slip de Cotação realizado",
        "Slip de cotação emitido no template Gallagher Re",
        "Cotações recebidas e arquivadas",
        "Ordem Firme formalizada",
        "100% da ordem colocada ou shortfall justificado",
        "Confirmação de participação dos resseguradores",
        "Exclusões e Subjetividades adequadas",
        "SPOE para Mudmap Final e email realizado",
        "SPOE para E-mail template realizado",
        "E-mail com Nota de Cobertura enviado",
        "Cláusulas obrigatórias incluídas (Intermediação, Insolvência, etc.)",
        "Acordo de divisão de comissão documentado",
        "Pro forma spreadsheet salvo",
        "Vigência da cobertura especificada adequadamente",
        "Brokerage e deduções especificadas corretamente",
        "Impostos aplicáveis identificados e documentados",
        "Cláusula de sanções (LMA 3100) incluída no contrato",
        "Confirmação salva na rede compartilhada",
        "Número de referência gerado no sistema Open Twins",
        "Slip de cotação emitido conforme template padrão",
        "Documentação de suporte arquivada adequadamente"
      ],
      "itens_nao_conformes": [
        "Relacionamento/acordo com Terceiro não documentado",
        "Negativa de resseguradores locais não documentada",
        "Exposição a territórios sancionados sem documentação",
        "Acordo adicional de fee não documentado",
        "Falta SPOE para Slip/Redação do Contrato",
        "Slips não cadastrados no controle de documentação"
      ],
      "itens_nao_aplicaveis": [
        "Aprovação Financial Crime não necessária",
        "Cláusula de Joint Broker não aplicável"
      ]
    },
    {
      "nome": "Companhia Paranaense de Energia (COPEL)",
      "referencia": "B133827COP0012",
      "ressegurado": "Porto Seguro Companhia de Seguros Gerais",
      "linha_negocio": "Energy & Utilities",
      "executivo": "Ana Paula Santos",
      "divisao": "LLP 7 - Gallagher Re Brazil",
      "total_controles": 36,
      "conformes": 31,
      "nao_conformes": 3,
      "nao_aplicaveis": 2,
      "problemas_spoe": 0,
      "taxa_conformidade": 91.2,
      "itens_conformes": [
        "TOBA enviado ao Cliente",
        "Instruções por escrito recebidas",
        "Resseguradores com licença local",
        "Ressegurador satisfaz Market Security Policy",
        "Ressegurador pré-aprovado pelo Cliente",
        "Parceiros comerciais aprovados",
        "Evidência da cotação salva",
        "SPOE para Slip de Cotação",
        "Slip de cotação emitido",
        "Cotações recebidas e arquivadas",
        "Ordem Firme formalizada",
        "100% da ordem colocada",
        "Confirmação de participação",
        "Negativa de resseguradores locais",
        "Exclusões adequadas",
        "SPOE para Mudmap Final",
        "SPOE para E-mail template",
        "E-mail com Nota de Cobertura",
        "Todas as cláusulas obrigatórias",
        "Acordo de divisão de comissão",
        "Pro forma spreadsheet salvo",
        "SPOE para Slip/Redação",
        "Slips cadastrados adequadamente",
        "Cláusula de Intermediação incluída",
        "Cláusula de Insolvência incluída",
        "Cláusula de Cancelamento incluída",
        "Vigência da cobertura especificada",
        "Impostos aplicáveis especificados",
        "Brokerage e deduções especificadas",
        "Confirmação salva na rede",
        "Arquivos suporte devidamente salvos"
      ],
      "itens_nao_conformes": [
        "Relacionamento com Terceiro não documentado",
        "Exposição a territórios sancionados sem documentação",
        "Acordo adicional de fee não documentado"
      ],
      "itens_nao_aplicaveis": [
        "Aprovação Financial Crime não necessária",
        "Cláusula de Joint Broker não aplicável"
      ]
    },
    {
      "nome": "Bresco Investimentos e Gestão LTDA.",
      "referencia": "B133828BRE0009",
      "ressegurado": "Bradesco Auto/RE Companhia de Seguros",
      "linha_negocio": "Financial Lines",
      "executivo": "Roberto Lima",
      "divisao": "LLP 7 - Gallagher Re Brazil",
      "total_controles": 32,
      "conformes": 27,
      "nao_conformes": 3,
      "nao_aplicaveis": 2,
      "problemas_spoe": 0,
      "taxa_conformidade": 87.1,
      "itens_conformes": [
        "Instruções por escrito recebidas",
        "Resseguradores com licença local",
        "Ressegurador satisfaz Market Security Policy",
        "Ressegurador pré-aprovado",
        "Parceiros comerciais aprovados",
        "Evidência da cotação salva",
        "Slip de cotação emitido",
        "TOBA enviado",
        "Confirmação do cliente recebida",
        "Referência gerada no Open Twins",
        "Confirmação salva na rede",
        "100% da ordem colocada",
        "Confirmação de participação",
        "Exclusões adequadas",
        "E-mail template enviado",
        "Todas as cláusulas obrigatórias incluídas",
        "Acordo de divisão de comissão",
        "Pro forma spreadsheet salvo",
        "Slips cadastrados",
        "SPOE para Slip de Cotação realizado",
        "Cotações recebidas e arquivadas adequadamente",
        "SPOE para Mudmap Final realizado",
        "E-mail com Nota de Cobertura enviado ao cliente",
        "Vigência da cobertura especificada no documento",
        "Impostos aplicáveis identificados",
        "Brokerage e deduções especificadas",
        "Arquivos suporte salvos na rede compartilhada"
      ],
      "itens_nao_conformes": [
        "Exposição a territórios sancionados sem documentação",
        "Data da Proposta e Aceitação não especificada",
        "Acordo adicional de fee não documentado"
      ],
      "itens_nao_aplicaveis": [
        "Negativa de resseguradores locais não aplicável",
        "Aprovação Financial Crime não necessária"
      ]
    },
    {
      "nome": "Grupo Casas Bahia S.A.",
      "referencia": "B133829CAS0015",
      "ressegurado": "Allianz Seguros S.A.",
      "linha_negocio": "Property and Construction",
      "executivo": "Mariana Costa",
      "divisao": "LLP 7 - Gallagher Re Brazil",
      "total_controles": 36,
      "conformes": 31,
      "nao_conformes": 4,
      "nao_aplicaveis": 1,
      "problemas_spoe": 0,
      "taxa_conformidade": 88.6,
      "itens_conformes": [
        "TOBA enviado ao Cliente",
        "Instruções por escrito recebidas",
        "Resseguradores com licença local",
        "Ressegurador satisfaz Market Security Policy",
        "Ressegurador pré-aprovado",
        "Parceiros comerciais aprovados",
        "Evidência da cotação salva",
        "SPOE para Slip de Cotação",
        "Slip de cotação emitido",
        "Cotações recebidas",
        "Ordem Firme formalizada",
        "100% da ordem colocada",
        "Confirmação de participação",
        "Negativa de resseguradores locais",
        "Exclusões adequadas",
        "SPOE para Mudmap Final",
        "SPOE para E-mail template",
        "E-mail com Nota de Cobertura",
        "Todas as cláusulas obrigatórias",
        "Acordo de divisão de comissão",
        "Pro forma spreadsheet salvo",
        "SPOE para Slip/Redação",
        "Slips cadastrados",
        "Cláusula de Intermediação incluída no contrato",
        "Cláusula de Insolvência incluída adequadamente",
        "Cláusula de Cancelamento especificada",
        "Vigência da cobertura definida claramente",
        "Impostos aplicáveis especificados no documento",
        "Brokerage e deduções calculadas corretamente",
        "Confirmação salva na rede compartilhada",
        "Número de referência gerado no Open Twins"
      ],
      "itens_nao_conformes": [
        "Relacionamento com Terceiro não documentado",
        "Exposição a territórios sancionados sem documentação",
        "Aprovação Financial Crime pendente",
        "Acordo adicional de fee não documentado"
      ],
      "itens_nao_aplicaveis": [
        "Cláusula de Joint Broker não aplicável"
      ]
    },
    {
      "nome": "End Prio Wahoo",
      "referencia": "B133830END0001",
      "ressegurado": "N/A",
      "linha_negocio": "N/A",
      "executivo": "N/A",
      "divisao": "LLP 7 - Gallagher Re Brazil",
      "total_controles": 15,
      "conformes": 0,
      "nao_conformes": 0,
      "nao_aplicaveis": 15,
      "problemas_spoe": 0,
      "taxa_conformidade": 0,
      "itens_conformes": [],
      "itens_nao_conformes": [],
      "itens_nao_aplicaveis": [
        "Todos os controles não aplicáveis para este endosso",
        "Instrução por escrito não aplicável",
        "Resseguradores licença local não aplicável",
        "Market Security Policy não aplicável",
        "Pré-aprovação não aplicável",
        "Parceiros comerciais não aplicável",
        "Evidência cotação não aplicável",
        "SPOE Slip não aplicável",
        "Slip cotação não aplicável",
        "TOBA não aplicável",
        "Ordem Firme não aplicável",
        "Referência Open Twins não aplicável",
        "Confirmação rede não aplicável",
        "Colocação ordem não aplicável",
        "Participação resseguradores não aplicável"
      ]
    },
    {
      "nome": "Voltalia - Endosso",
      "referencia": "B133831VOL0002",
      "ressegurado": "Seguros Sura S.A.",
      "linha_negocio": "Energy & Renewable",
      "executivo": "Patricia Mendes",
      "divisao": "LLP 7 - Gallagher Re Brazil",
      "total_controles": 18,
      "conformes": 15,
      "nao_conformes": 2,
      "nao_aplicaveis": 1,
      "problemas_spoe": 0,
      "taxa_conformidade": 88.2,
      "itens_conformes": [
        "Instruções por escrito recebidas para endosso",
        "Endosso inserido no Open Twins",
        "Verificação SPOE para Endosso Final realizada",
        "Endosso assinado por todos os resseguradores",
        "Exclusões e condições expressas adequadamente",
        "Confirmação do endosso informada ao cliente",
        "Arquivos suporte devidamente salvos",
        "Alterações de prêmio calculadas corretamente",
        "Documentação anterior consultada",
        "Impacto nas coberturas avaliado",
        "Comunicação com resseguradores adequada",
        "Template de endosso utilizado",
        "Aprovações internas obtidas",
        "Registro de alterações documentado",
        "Vigência do endosso especificada"
      ],
      "itens_nao_conformes": [
        "Exposição a territórios sancionados sem documentação adequada",
        "Modelo de e-mail template não utilizado adequadamente"
      ],
      "itens_nao_aplicaveis": [
        "Aprovação do time de Financial Crime não necessária"
      ]
    }
  ]
};

// Global variables
let conformidadeChart, statusChart, categoriesChart;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeKPIs();
    initializeContractSelect();
});

// Initialize KPIs - Only 3 KPIs now
function initializeKPIs() {
    // Calculate metrics
    const totalSim = dashboardDataExato.contratos.reduce((sum, contrato) => sum + contrato.conformes, 0);
    const totalNao = dashboardDataExato.contratos.reduce((sum, contrato) => sum + contrato.nao_conformes, 0);
    const totalValidos = totalSim + totalNao;
    const riscosComSpoe = dashboardDataExato.contratos.filter(contrato => contrato.problemas_spoe > 0).length;
    
    const taxaSim = (totalSim / totalValidos * 100).toFixed(1) + "%";
    const taxaNao = (totalNao / totalValidos * 100).toFixed(1) + "%";
    
    // Update KPI values - only 3 cards now
    document.getElementById('total-contratos').textContent = dashboardDataExato.contratos.length;
    document.getElementById('taxa-sim').textContent = taxaSim;
    document.getElementById('taxa-nao').textContent = taxaNao;
    
    // Update SPOE indicator in section header
    document.getElementById('riscos-spoe').textContent = riscosComSpoe;
}

// Initialize Contract Select with SPOE indicators
function initializeContractSelect() {
    const select = document.getElementById('contract-select');
    
    dashboardDataExato.contratos.forEach((contract, index) => {
        const option = document.createElement('option');
        option.value = index;
        
        // Add warning indicator for contracts with SPOE problems
        if (contract.problemas_spoe > 0) {
            option.textContent = `${contract.nome} ⚠️`;
            option.classList.add('contract-with-spoe');
        } else {
            option.textContent = contract.nome;
        }
        
        select.appendChild(option);
    });
    
    select.addEventListener('change', function() {
        if (this.value !== '') {
            showContractDetails(parseInt(this.value));
        } else {
            hideContractDetails();
        }
    });
}

// Show Contract Details - Simplified to show only risk name
function showContractDetails(contractIndex) {
    const contract = dashboardDataExato.contratos[contractIndex];
    const detailsDiv = document.getElementById('contract-details');
    
    // Update basic info - only showing risk name now
    document.getElementById('contract-name').textContent = contract.nome;
    
    // Update counts
    document.getElementById('conformes-count').textContent = contract.itens_conformes.length;
    document.getElementById('nao-conformes-count').textContent = contract.itens_nao_conformes.length;
    document.getElementById('nao-aplicaveis-count').textContent = contract.itens_nao_aplicaveis.length;
    
    // Update lists with exact questions and SPOE highlighting
    updateConformanceList('conformes-list', contract.itens_conformes);
    updateConformanceList('nao-conformes-list', contract.itens_nao_conformes);
    updateConformanceList('nao-aplicaveis-list', contract.itens_nao_aplicaveis);
    
    // Show details
    detailsDiv.classList.remove('hidden');
    
    // Collapse all lists initially
    document.querySelectorAll('.conformance-list').forEach(list => {
        list.classList.add('hidden');
    });
    document.querySelectorAll('.list-header').forEach(header => {
        header.classList.add('collapsed');
    });
}

// Hide Contract Details
function hideContractDetails() {
    document.getElementById('contract-details').classList.add('hidden');
}

// Update Conformance List with exact questions and SPOE highlighting
function updateConformanceList(listId, items) {
    const list = document.getElementById(listId);
    list.innerHTML = '';
    
    items.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        
        // Highlight SPOE items with special styling
        if (item.toLowerCase().includes('spoe')) {
            li.classList.add('spoe-item');
        }
        
        list.appendChild(li);
    });
}

// Toggle List
function toggleList(listType) {
    const list = document.getElementById(listType + '-list');
    const header = list.previousElementSibling;
    
    if (list.classList.contains('hidden')) {
        list.classList.remove('hidden');
        header.classList.remove('collapsed');
    } else {
        list.classList.add('hidden');
        header.classList.add('collapsed');
    }
}